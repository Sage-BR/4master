#!/bin/bash
IF=ens3
WG_PORT=443  # ajuste se necessário

# ─────────────────────────────────────────
# LIMPEZA
# ─────────────────────────────────────────
tc qdisc del dev $IF root 2>/dev/null || true
tc qdisc del dev $IF ingress 2>/dev/null || true
ip link del ifb0 2>/dev/null || true

# ─────────────────────────────────────────
# INGRESS (via IFB)
# ─────────────────────────────────────────
modprobe ifb numifbs=1
ip link add ifb0 type ifb
ip link set ifb0 up

tc qdisc add dev $IF ingress
tc filter add dev $IF parent ffff: protocol ip u32 match u32 0 0 \
    action mirred egress redirect dev ifb0

# ─────────────────────────────────────────
# EGRESS — tráfego saindo do servidor
# ─────────────────────────────────────────
if tc qdisc add dev $IF root cake bandwidth 1gbit diffserv4 2>/dev/null; then
    echo "CAKE egress ativado"
    CAKE_OK=1
else
    echo "CAKE não disponível, usando HTB+fq_codel"
    CAKE_OK=0
    tc qdisc add dev $IF root handle 1: htb default 30
    tc class add dev $IF parent 1: classid 1:1 htb rate 1gbit
    tc class add dev $IF parent 1:1 classid 1:10 htb rate 950mbit ceil 1gbit prio 1 burst 1k
    tc class add dev $IF parent 1:1 classid 1:30 htb rate 50mbit  ceil 1gbit prio 3 burst 15k
    tc qdisc add dev $IF parent 1:10 handle 10: fq_codel target 500us interval 5ms quantum 300
    tc qdisc add dev $IF parent 1:30 handle 30: fq_codel target 5ms interval 50ms
    tc filter add dev $IF parent 1: protocol ip prio 1 u32 \
        match ip protocol 17 0xff \
        match ip sport $WG_PORT 0xffff \
        flowid 1:10
    tc filter add dev $IF parent 1: protocol ip prio 2 u32 \
        match ip protocol 17 0xff \
        match ip dport $WG_PORT 0xffff \
        flowid 1:10
    tc filter add dev $IF parent 1: protocol ip prio 10 u32 \
        match u32 0 0 \
        flowid 1:30
fi

# ─────────────────────────────────────────
# INGRESS — tráfego entrando no servidor
# ─────────────────────────────────────────
if [ "$CAKE_OK" = "1" ] && tc qdisc add dev ifb0 root cake bandwidth 1gbit diffserv4 ingress 2>/dev/null; then
    echo "CAKE ingress ativado"
else
    echo "Usando HTB+fq_codel no ingress"
    tc qdisc add dev ifb0 root handle 1: htb default 30
    tc class add dev ifb0 parent 1: classid 1:1 htb rate 1gbit
    tc class add dev ifb0 parent 1:1 classid 1:10 htb rate 950mbit ceil 1gbit prio 1 burst 1k
    tc class add dev ifb0 parent 1:1 classid 1:30 htb rate 50mbit  ceil 1gbit prio 3 burst 15k
    tc qdisc add dev ifb0 parent 1:10 handle 10: fq_codel target 500us interval 5ms quantum 300
    tc qdisc add dev ifb0 parent 1:30 handle 30: fq_codel target 5ms interval 50ms
    tc filter add dev ifb0 parent 1: protocol ip prio 1 u32 \
        match ip protocol 17 0xff \
        match ip dport $WG_PORT 0xffff \
        flowid 1:10
    tc filter add dev ifb0 parent 1: protocol ip prio 2 u32 \
        match ip protocol 17 0xff \
        match ip sport $WG_PORT 0xffff \
        flowid 1:10
    tc filter add dev ifb0 parent 1: protocol ip prio 10 u32 \
        match u32 0 0 \
        flowid 1:30
fi

# ─────────────────────────────────────────
# DSCP marking — prioriza WireGuard no CAKE
# (só tem efeito com diffserv4)
# ─────────────────────────────────────────
iptables -t mangle -F
iptables -t mangle -A PREROUTING  -p udp --dport $WG_PORT -j DSCP --set-dscp-class EF
iptables -t mangle -A PREROUTING  -p udp --sport $WG_PORT -j DSCP --set-dscp-class EF
iptables -t mangle -A POSTROUTING -p udp --dport $WG_PORT -j DSCP --set-dscp-class EF
iptables -t mangle -A POSTROUTING -p udp --sport $WG_PORT -j DSCP --set-dscp-class EF

# ─────────────────────────────────────────
# VERIFICAÇÃO
# ─────────────────────────────────────────
echo ""
echo "=== egress ($IF) ==="
tc qdisc show dev $IF

echo ""
echo "=== ingress (ifb0) ==="
tc qdisc show dev ifb0
