#!/bin/sh -e
#
# rc.local - ProteÃ§Ãµes de rede avanÃ§adas + VPN + Anti-DDoS AutomÃ¡tico (VPS INTEIRO)
#

### ðŸ”’ PolÃ­ticas PadrÃ£o
/sbin/iptables -P INPUT DROP
/sbin/iptables -P FORWARD DROP
/sbin/iptables -P OUTPUT ACCEPT

### ðŸŸ¢ Regras BÃ¡sicas
/sbin/iptables -A INPUT -i lo -j ACCEPT
/sbin/iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
/sbin/iptables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

### ðŸ” ExceÃ§Ã£o VPN (WireGuard wg0)
/sbin/iptables -I INPUT -i wg0 -j ACCEPT
/sbin/iptables -I FORWARD -i wg0 -j ACCEPT
/sbin/iptables -I FORWARD -o wg0 -j ACCEPT
/sbin/iptables -A OUTPUT -o wg0 -j ACCEPT

### --- Anti-spoofing bÃ¡sico ---
/sbin/iptables -A INPUT -s 127.0.0.0/8 ! -i lo -j DROP
/sbin/iptables -A INPUT -s 224.0.0.0/4 -j DROP
/sbin/iptables -A INPUT -s 240.0.0.0/5 -j DROP
/sbin/iptables -A INPUT -s 169.254.0.0/16 -j DROP
/sbin/iptables -A INPUT -s 0.0.0.0/8 -j DROP
/sbin/iptables -A INPUT -s 255.255.255.255 -j DROP

### --- Chain personalizada para bloqueios extras ---
/sbin/iptables -N BLOCKLIST 2>/dev/null || true
/sbin/iptables -F BLOCKLIST

### ðŸ›¡ï¸ === PROTEÃ‡ÃƒO GLOBAL ANTI-DDOS (TODO O VPS) ===
# Cria chain para tracking de conexÃµes abusivas
/sbin/iptables -N GLOBAL_PROTECT 2>/dev/null || true
/sbin/iptables -F GLOBAL_PROTECT

# Bloqueia IPs banidos por 30 minutos
/sbin/iptables -A GLOBAL_PROTECT -m recent --name GLOBAL_BAN --rcheck --seconds 1800 -j DROP

# Detecta flood agressivo: mais de 8 conexÃµes em 5 segundos
/sbin/iptables -A GLOBAL_PROTECT -m recent --name GLOBAL_FLOOD --update --seconds 5 --hitcount 8 -m recent --name GLOBAL_BAN --set -j DROP
/sbin/iptables -A GLOBAL_PROTECT -m recent --name GLOBAL_FLOOD --set

# Detecta tentativas com pacotes invÃ¡lidos repetidos
/sbin/iptables -A GLOBAL_PROTECT -m recent --name GLOBAL_INVALID --update --seconds 10 --hitcount 5 -m recent --name GLOBAL_BAN --set -j DROP

# Limita conexÃµes simultÃ¢neas por IP (mÃ¡ximo 30 conexÃµes)
/sbin/iptables -A GLOBAL_PROTECT -m connlimit --connlimit-above 30 --connlimit-mask 32 -j REJECT --reject-with tcp-reset

# Rate limit para novas conexÃµes (2 por segundo, burst de 5)
/sbin/iptables -A GLOBAL_PROTECT -m conntrack --ctstate NEW -m limit --limit 2/s --limit-burst 5 -j ACCEPT
/sbin/iptables -A GLOBAL_PROTECT -m conntrack --ctstate NEW -j DROP

### âŒ Bloquear Pacotes InvÃ¡lidos GLOBALMENTE
/sbin/iptables -A INPUT -m conntrack --ctstate INVALID -m recent --name GLOBAL_INVALID --set -j DROP
/sbin/iptables -A FORWARD -m conntrack --ctstate INVALID -m recent --name GLOBAL_INVALID --set -j DROP

### ðŸš« Bloquear FLAGS TCP Suspeitas (TODO O VPS)
# Pacote NULL
/sbin/iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
# XMAS packet
/sbin/iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
# SYN+FIN
/sbin/iptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
# SYN+RST
/sbin/iptables -A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
# FIN+RST
/sbin/iptables -A INPUT -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
# FIN sem ACK
/sbin/iptables -A INPUT -p tcp --tcp-flags FIN,ACK FIN -j DROP
# PSH sem ACK
/sbin/iptables -A INPUT -p tcp --tcp-flags ACK,PSH PSH -j DROP
# URG sem ACK
/sbin/iptables -A INPUT -p tcp --tcp-flags ACK,URG URG -j DROP

### ðŸ” ProteÃ§Ã£o contra SYN Flood GLOBAL
/sbin/iptables -A INPUT -p tcp --syn -m limit --limit 2/s --limit-burst 4 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --syn -j DROP

### ðŸ” ProteÃ§Ã£o contra Port Scan GLOBAL
/sbin/iptables -N PORTSCAN 2>/dev/null || true
/sbin/iptables -F PORTSCAN
/sbin/iptables -A PORTSCAN -p tcp --tcp-flags SYN,ACK,FIN,RST RST -m limit --limit 1/s --limit-burst 2 -j RETURN
/sbin/iptables -A PORTSCAN -m recent --name PORTSCAN --set -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags SYN,ACK,FIN,RST RST -j PORTSCAN

### ðŸ” ProteÃ§Ã£o contra brute-force SSH
/sbin/iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -m recent --set
/sbin/iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -m recent --update --seconds 60 --hitcount 5 -j DROP

### ðŸ“¡ Limitar ICMP (Ping) GLOBALMENTE
/sbin/iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s --limit-burst 3 -j ACCEPT
/sbin/iptables -A INPUT -p icmp --icmp-type echo-request -j DROP
/sbin/iptables -A INPUT -p icmp -j ACCEPT

### ðŸŒ Permitir DNS (TCP e UDP)
/sbin/iptables -A INPUT -p udp --sport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --sport 53 -j ACCEPT
/sbin/iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
/sbin/iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT

### ðŸŒ Aplicar PROTEÃ‡ÃƒO GLOBAL em TODAS as portas TCP
/sbin/iptables -A INPUT -i eth0 -p tcp -j GLOBAL_PROTECT
/sbin/iptables -A FORWARD -i eth0 -p tcp -j GLOBAL_PROTECT

### ðŸŽ® ProteÃ§Ã£o EXTRA especÃ­fica para Lineage (em cima da proteÃ§Ã£o global)
# Limita ainda mais as portas do jogo: 2 conexÃµes simultÃ¢neas por IP
/sbin/iptables -A INPUT -p tcp --dport 2106 -m connlimit --connlimit-above 2 --connlimit-mask 32 -j REJECT --reject-with tcp-reset
/sbin/iptables -A INPUT -p tcp --dport 7777 -m connlimit --connlimit-above 2 --connlimit-mask 32 -j REJECT --reject-with tcp-reset
/sbin/iptables -A FORWARD -p tcp --dport 2106 -m connlimit --connlimit-above 2 --connlimit-mask 32 -j REJECT --reject-with tcp-reset
/sbin/iptables -A FORWARD -p tcp --dport 7777 -m connlimit --connlimit-above 2 --connlimit-mask 32 -j REJECT --reject-with tcp-reset

### ðŸŒ Permitir Portas do Servidor (TCP/UDP) - apÃ³s proteÃ§Ãµes
/sbin/iptables -A INPUT -p tcp -m multiport --dports 3306,7777,2106,9014,2000,445 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
/sbin/iptables -A INPUT -p udp -m multiport --dports 3306,7777,2106,9014,445 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT

### ðŸ”€ Forwarding da VPN
/sbin/iptables -A FORWARD -i wg0 -o eth0 -s 10.66.66.0/24 -j ACCEPT

### === ðŸ”„ Redirecionamentos (DNAT) ===
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3306 -j DNAT --to-destination 10.66.66.2:3306
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 7777 -j DNAT --to-destination 10.66.66.2:7777
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 2106 -j DNAT --to-destination 10.66.66.2:2106
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 9014 -j DNAT --to-destination 10.66.66.2:9014
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 2000 -j DNAT --to-destination 10.66.66.2:2000
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 445 -j DNAT --to-destination 10.66.66.2:445

### ðŸ”„ Forward Rules (com proteÃ§Ã£o global jÃ¡ aplicada)
# De fora para o cliente
/sbin/iptables -A FORWARD -i eth0 -o wg0 -d 10.66.66.2 -p tcp -m multiport --dports 2000,445,53,9014,3306,2106,7777 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
# Do cliente para fora
/sbin/iptables -A FORWARD -i wg0 -o eth0 -s 10.66.66.2 -p tcp -m multiport --sports 2000,445,53,9014,3306,2106,7777 -m conntrack --ctstate ESTABLISHED -j ACCEPT

### ðŸ” SYNPROXY GLOBAL (exceto porta 445 e VPN)
/sbin/iptables -A FORWARD -i eth0 -p tcp ! --dport 445 -m state --state INVALID,UNTRACKED -j SYNPROXY --sack-perm --timestamp --wscale 7 --mss 1460
/sbin/iptables -A FORWARD -i eth0 -p tcp ! --dport 445 -m state --state INVALID -j DROP

### ðŸŒ Permitir saÃ­da (OUTPUT)
/sbin/iptables -A OUTPUT -p tcp -j ACCEPT
/sbin/iptables -A OUTPUT -p udp -j ACCEPT

### ðŸ“Š Logging de ataques bloqueados
/sbin/iptables -N LOGDROP 2>/dev/null || true
/sbin/iptables -F LOGDROP
/sbin/iptables -A LOGDROP -m limit --limit 5/min -j LOG --log-prefix "IPTABLES-BLOCKED: " --log-level 4
/sbin/iptables -A LOGDROP -j DROP

### ðŸš« Aplicar BLOCKLIST antes de rejeitar
/sbin/iptables -I INPUT 1 -j BLOCKLIST
/sbin/iptables -I FORWARD 1 -j BLOCKLIST

### ðŸš« Rejeitar tudo nÃ£o permitido
/sbin/iptables -A INPUT -j LOGDROP
/sbin/iptables -A FORWARD -j LOGDROP

echo "Firewall carregado com proteÃ§Ã£o GLOBAL em todo o VPS"

exit 0
