#!/bin/sh -e
#
# rc.local - Firewall Profissional com Prote√ß√£o DDoS Balanceada
#

### üîí Pol√≠ticas Padr√£o
/sbin/iptables -P INPUT DROP
/sbin/iptables -P FORWARD DROP
/sbin/iptables -P OUTPUT ACCEPT

### üßπ Limpar chains (NAT gerenciado pelo WireGuard)
/sbin/iptables -F INPUT
/sbin/iptables -F FORWARD
/sbin/iptables -F OUTPUT
/sbin/iptables -X

### üîß Criar chains personalizadas
/sbin/iptables -N BLOCKLIST 2>/dev/null || true
/sbin/iptables -N SSH_PROTECT 2>/dev/null || true
/sbin/iptables -N L2_PROTECT 2>/dev/null || true
/sbin/iptables -N WEB_PROTECT 2>/dev/null || true
/sbin/iptables -N PORTSCAN 2>/dev/null || true
/sbin/iptables -N LOGDROP 2>/dev/null || true

### ==========================================
### CAMADA 1: TR√ÅFEGO CONFI√ÅVEL (BYPASS TOTAL)
### ==========================================

### üü¢ Loopback (sem limita√ß√µes)
/sbin/iptables -A INPUT -i lo -j ACCEPT
/sbin/iptables -A OUTPUT -o lo -j ACCEPT

### üîê VPN WireGuard (totalmente confi√°vel)
/sbin/iptables -A INPUT -i wg0 -j ACCEPT
/sbin/iptables -A OUTPUT -o wg0 -j ACCEPT

### üîÑ Conex√µes estabelecidas (maior volume, sem limita√ß√µes)
/sbin/iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
/sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
/sbin/iptables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

### ==========================================
### CAMADA 2: BLOQUEIOS CR√çTICOS (MALWARE/SPOOFING)
### ==========================================

### üö´ BLOCKLIST (IPs banidos manualmente)
/sbin/iptables -A INPUT -j BLOCKLIST
/sbin/iptables -A FORWARD -j BLOCKLIST

### ‚ùå Pacotes Inv√°lidos (malformados)
/sbin/iptables -A INPUT -m conntrack --ctstate INVALID -j DROP
/sbin/iptables -A FORWARD -m conntrack --ctstate INVALID -j DROP

### üö´ Anti-spoofing (IPs imposs√≠veis)
/sbin/iptables -A INPUT -s 127.0.0.0/8 ! -i lo -j DROP
/sbin/iptables -A INPUT -s 224.0.0.0/4 -j DROP
/sbin/iptables -A INPUT -s 240.0.0.0/5 -j DROP
/sbin/iptables -A INPUT -s 169.254.0.0/16 -j DROP
/sbin/iptables -A INPUT -s 0.0.0.0/8 -j DROP
/sbin/iptables -A INPUT -s 255.255.255.255 -j DROP

### üö´ FLAGS TCP Maliciosas (ataques conhecidos)
/sbin/iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags FIN,ACK FIN -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags ACK,PSH PSH -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags ACK,URG URG -j DROP

### ==========================================
### CAMADA 3: PROTE√á√ïES CUSTOMIZADAS POR SERVI√áO
### ==========================================

### üîê SSH_PROTECT - Prote√ß√£o moderada (brute-force)
# Ban ap√≥s 6 tentativas em 2 minutos
/sbin/iptables -A SSH_PROTECT -m recent --name SSH_ATTACK --rcheck --seconds 120 --hitcount 6 -j DROP
/sbin/iptables -A SSH_PROTECT -m recent --name SSH_ATTACK --set
# Limite de 3 conex√µes simult√¢neas por IP
/sbin/iptables -A SSH_PROTECT -m connlimit --connlimit-above 3 --connlimit-mask 32 -j REJECT --reject-with tcp-reset
/sbin/iptables -A SSH_PROTECT -j ACCEPT

### üéÆ L2_PROTECT - Prote√ß√£o balanceada (permite reconex√µes)
# Ban tempor√°rio apenas em caso extremo (30 tentativas em 60s)
/sbin/iptables -A L2_PROTECT -m recent --name L2_EXTREME --rcheck --seconds 60 --hitcount 30 -j DROP
/sbin/iptables -A L2_PROTECT -m recent --name L2_EXTREME --set

# Limite de 8 conex√µes simult√¢neas por IP (permite dual-box)
/sbin/iptables -A L2_PROTECT -m connlimit --connlimit-above 8 --connlimit-mask 32 -j REJECT --reject-with tcp-reset

# Rate limit generoso: 15 novas conex√µes/segundo, burst 30
/sbin/iptables -A L2_PROTECT -m conntrack --ctstate NEW -m limit --limit 15/s --limit-burst 30 -j ACCEPT
/sbin/iptables -A L2_PROTECT -m conntrack --ctstate NEW -j DROP

### üåê WEB_PROTECT - Prote√ß√£o padr√£o web (MySQL, SMB, etc)
# Ban em caso de flood severo (50 conex√µes em 30s)
/sbin/iptables -A WEB_PROTECT -m recent --name WEB_FLOOD --rcheck --seconds 30 --hitcount 50 -j DROP
/sbin/iptables -A WEB_PROTECT -m recent --name WEB_FLOOD --set

# Limite de 30 conex√µes simult√¢neas por IP
/sbin/iptables -A WEB_PROTECT -m connlimit --connlimit-above 30 --connlimit-mask 32 -j REJECT --reject-with tcp-reset

# Rate limit: 10 novas conex√µes/segundo, burst 20
/sbin/iptables -A WEB_PROTECT -m conntrack --ctstate NEW -m limit --limit 10/s --limit-burst 20 -j ACCEPT
/sbin/iptables -A WEB_PROTECT -m conntrack --ctstate NEW -j DROP

### üîç PORTSCAN - Detec√ß√£o de varredura de portas
/sbin/iptables -A PORTSCAN -m recent --name PORTSCAN_ATTACK --set --rsource
/sbin/iptables -A PORTSCAN -m recent --name PORTSCAN_ATTACK --rcheck --seconds 300 --hitcount 10 --rsource -j DROP
/sbin/iptables -A PORTSCAN -p tcp --tcp-flags SYN,ACK,FIN,RST RST -m limit --limit 1/s --limit-burst 2 -j RETURN
/sbin/iptables -A PORTSCAN -j DROP

### ==========================================
### CAMADA 4: SERVI√áOS ESSENCIAIS (SEM PROTE√á√ÉO)
### ==========================================

### üì° ICMP (Ping) - Rate limit leve
/sbin/iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 5/s --limit-burst 10 -j ACCEPT
/sbin/iptables -A INPUT -p icmp --icmp-type echo-request -j DROP
/sbin/iptables -A INPUT -p icmp -j ACCEPT

### üåê DNS (essencial, sem limita√ß√µes)
/sbin/iptables -A INPUT -p udp --sport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --sport 53 -j ACCEPT
/sbin/iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
/sbin/iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT

### ==========================================
### CAMADA 5: SERVI√áOS P√öBLICOS COM PROTE√á√ÉO
### ==========================================

### üîê SSH (porta 22) - Prote√ß√£o contra brute-force
/sbin/iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j SSH_PROTECT

### üéÆ LINEAGE 2 - Prote√ß√£o balanceada
# Login Server (2106)
/sbin/iptables -A INPUT -i eth0 -p tcp --dport 2106 -m conntrack --ctstate NEW -j L2_PROTECT
/sbin/iptables -A INPUT -i eth0 -p tcp --dport 2106 -j ACCEPT

# Game Server (7777)
/sbin/iptables -A INPUT -i eth0 -p tcp --dport 7777 -m conntrack --ctstate NEW -j L2_PROTECT
/sbin/iptables -A INPUT -i eth0 -p tcp --dport 7777 -j ACCEPT

### üåê Outras portas - Prote√ß√£o padr√£o web
# MySQL (3306), SMB (445), Management (9014, 2000)
/sbin/iptables -A INPUT -p tcp -m multiport --dports 3306,9014,2000,445 -m conntrack --ctstate NEW -j WEB_PROTECT
/sbin/iptables -A INPUT -p tcp -m multiport --dports 3306,9014,2000,445 -j ACCEPT
/sbin/iptables -A INPUT -p udp -m multiport --dports 3306,9014,445 -j ACCEPT

### üîê Anti Port-Scan (apenas portas n√£o essenciais)
/sbin/iptables -A INPUT -p tcp -m multiport ! --dports 22,2106,7777,3306,9014,2000,445 --tcp-flags SYN,ACK,FIN,RST RST -j PORTSCAN

### ==========================================
### CAMADA 6: FORWARD (VPN ‚Üí Servidor L2)
### ==========================================

### üéÆ Prote√ß√£o Lineage2 no FORWARD (mesma l√≥gica do INPUT)
/sbin/iptables -A FORWARD -p tcp --dport 2106 -m conntrack --ctstate NEW -j L2_PROTECT
/sbin/iptables -A FORWARD -p tcp --dport 7777 -m conntrack --ctstate NEW -j L2_PROTECT

### üåê Prote√ß√£o WEB no FORWARD (outras portas)
/sbin/iptables -A FORWARD -p tcp -m multiport --dports 3306,9014,2000,445 -m conntrack --ctstate NEW -j WEB_PROTECT

### üîÄ Forward VPN (depois das prote√ß√µes)
# Sa√≠da da VPN (tudo permitido ap√≥s prote√ß√£o)
/sbin/iptables -A FORWARD -i wg0 -o eth0 -s 10.66.66.0/24 -j ACCEPT

# Entrada na VPN (apenas portas espec√≠ficas)
/sbin/iptables -A FORWARD -i eth0 -o wg0 -d 10.66.66.2 -p tcp -m multiport --dports 2000,445,9014,3306,2106,7777 -j ACCEPT

# Respostas do servidor L2
/sbin/iptables -A FORWARD -i wg0 -o eth0 -s 10.66.66.2 -p tcp -m multiport --sports 2000,445,9014,3306,2106,7777 -j ACCEPT

### ==========================================
### CAMADA 7: LOGGING E BLOQUEIO FINAL
### ==========================================

### üìä LOGDROP - Log seletivo
/sbin/iptables -A LOGDROP -m limit --limit 3/min -j LOG --log-prefix "FW-DROP: " --log-level 4
/sbin/iptables -A LOGDROP -j DROP

### üåç OUTPUT - Tudo permitido
/sbin/iptables -A OUTPUT -j ACCEPT

### üö´ Bloquear resto (o que n√£o passou pelas regras acima)
/sbin/iptables -A INPUT -j LOGDROP
/sbin/iptables -A FORWARD -j LOGDROP

exit 0
