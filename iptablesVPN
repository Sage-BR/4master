#!/bin/sh -e
#
# rc.local - Prote√ß√µes de rede avan√ßadas + VPN
#

### üîí Pol√≠ticas Padr√£o
/sbin/iptables -P INPUT DROP
/sbin/iptables -P FORWARD DROP
/sbin/iptables -P OUTPUT ACCEPT

### üü¢ Regras B√°sicas
/sbin/iptables -A INPUT -i lo -j ACCEPT
/sbin/iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
/sbin/iptables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

### üîê Exce√ß√£o VPN (WireGuard wg0)
/sbin/iptables -I INPUT -i wg0 -j ACCEPT
/sbin/iptables -I FORWARD -i wg0 -j ACCEPT
/sbin/iptables -I FORWARD -o wg0 -j ACCEPT
/sbin/iptables -A OUTPUT -o wg0 -j ACCEPT

### --- Anti-spoofing b√°sico ---
/sbin/iptables -A INPUT -s 127.0.0.0/8 ! -i lo -j DROP
/sbin/iptables -A INPUT -s 224.0.0.0/4 -j DROP
/sbin/iptables -A INPUT -s 240.0.0.0/5 -j DROP
/sbin/iptables -A INPUT -s 169.254.0.0/16 -j DROP

### --- Chain personalizada para bloqueios extras ---
/sbin/iptables -N BLOCKLIST 2>/dev/null || true

### ‚ùå Bloquear Pacotes Inv√°lidos
/sbin/iptables -A INPUT -m conntrack --ctstate INVALID -j DROP
/sbin/iptables -A FORWARD -m conntrack --ctstate INVALID -j DROP

### üîê Prote√ß√£o contra SYN Flood
/sbin/iptables -A INPUT -i eth0 -p tcp --syn -m limit --limit 1/s --limit-burst 3 -j ACCEPT
/sbin/iptables -A INPUT -i eth0 -p tcp --syn -j DROP

### üîê Prote√ß√£o contra brute-force SSH (porta 35556)
/sbin/iptables -A INPUT -p tcp --dport 35556 -m conntrack --ctstate NEW -m recent --set
/sbin/iptables -A INPUT -p tcp --dport 35556 -m conntrack --ctstate NEW -m recent --update --seconds 60 --hitcount 10 -j DROP

### üîç Prote√ß√£o contra Scan de Portas
/sbin/iptables -N PORTSCAN 2>/dev/null || true
/sbin/iptables -A PORTSCAN -p tcp --tcp-flags SYN,ACK,FIN,RST RST -m limit --limit 1/s --limit-burst 2 -j RETURN
/sbin/iptables -A PORTSCAN -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP

### üìâ Limitar Conex√µes Simult√¢neas por IP
/sbin/iptables -A INPUT -p tcp -m connlimit --connlimit-above 111 -j REJECT --reject-with tcp-reset

### ‚õîÔ∏è Limitar Novas Conex√µes TCP
/sbin/iptables -A INPUT -p tcp -m conntrack --ctstate NEW -m limit --limit 60/s --limit-burst 20 -j ACCEPT
/sbin/iptables -A INPUT -p tcp -m conntrack --ctstate NEW -j DROP

### üì° Limitar ICMP (Ping)
/sbin/iptables -I INPUT -p icmp -m hashlimit --hashlimit-name icmp --hashlimit-mode srcip --hashlimit 3/second --hashlimit-burst 5 -j ACCEPT

### üåê Permitir DNS (TCP e UDP)
/sbin/iptables -A INPUT -p udp --sport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --sport 53 -j ACCEPT
/sbin/iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
/sbin/iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT

### üåê Permitir Portas do Servidor (TCP/UDP)
/sbin/iptables -A INPUT -p tcp -m multiport --dports 30000,7777,2106,9014,3000,445 -m conntrack --ctstate NEW -j ACCEPT
/sbin/iptables -A INPUT -p udp -m multiport --dports 30000,7777,2106,9014,445 -m conntrack --ctstate NEW -j ACCEPT

### üîÄ Forwarding da VPN
/sbin/iptables -A FORWARD -i wg0 -o eth0 -s 10.66.66.0/24 -j ACCEPT

### === üîÑ Redirecionamentos (DNAT) ===
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3306 -j DNAT --to-destination 10.66.66.2:3306
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 7777 -j DNAT --to-destination 10.66.66.2:7777
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 2106 -j DNAT --to-destination 10.66.66.2:2106
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 9014 -j DNAT --to-destination 10.66.66.2:9014
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3000 -j DNAT --to-destination 10.66.66.2:3000
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 445 -j DNAT --to-destination 10.66.66.2:445

### üîÑ Forward Rules
# De fora para o cliente
/sbin/iptables -A FORWARD -i eth0 -o wg0 -d 10.66.66.2 -p tcp -m multiport --dports 445,53,9014,3306,2106,7777 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
# Do cliente para fora
/sbin/iptables -A FORWARD -i wg0 -o eth0 -s 10.66.66.2 -p tcp -m multiport --sports 3000,445,53,9014,3306,2106,7777 -m conntrack --ctstate ESTABLISHED -j ACCEPT

### üîê SYNPROXY (exceto porta 445)
/sbin/iptables -A FORWARD -i eth0 -p tcp -m multiport --dports 3000,53,9014,3306,2106,7777 -m state --state INVALID,UNTRACKED -j SYNPROXY --sack-perm --timestamp --wscale 7 --mss 1460
/sbin/iptables -A FORWARD -i eth0 -p tcp -m multiport --dports 3000,53,9014,3306,2106,7777 -m state --state INVALID -j DROP

### üåç Permitir sa√≠da (OUTPUT)
/sbin/iptables -A OUTPUT -p tcp -m multiport --dports 30000,445,35556,53,9014,3306,2106,7777 -j ACCEPT

### üö´ Rejeitar tudo n√£o permitido
/sbin/iptables -A INPUT -j REJECT --reject-with icmp-port-unreachable
/sbin/iptables -A FORWARD -j REJECT --reject-with icmp-port-unreachable

exit 0
