#!/bin/sh -e
#
# rc.local - Firewall com SSH SEMPRE ACESS√çVEL (Anti-Lockout)
#

### üîí Pol√≠ticas Padr√£o
/sbin/iptables -P INPUT DROP
/sbin/iptables -P FORWARD DROP
/sbin/iptables -P OUTPUT ACCEPT

### üßπ Limpar tudo
/sbin/iptables -F
/sbin/iptables -X
/sbin/iptables -t nat -F

### üîß Criar chains personalizadas
/sbin/iptables -N BLOCKLIST 2>/dev/null || true
/sbin/iptables -N GLOBAL_PROTECT 2>/dev/null || true
/sbin/iptables -N PORTSCAN 2>/dev/null || true
/sbin/iptables -N LOGDROP 2>/dev/null || true

### ==========================================
### üî¥ CAMADA 0: SSH SEMPRE LIBERADO (ANTI-LOCKOUT)
### ==========================================
### PRIMEIRA REGRA = SSH NUNCA BLOQUEIA
/sbin/iptables -A INPUT -p tcp --dport 22 -j ACCEPT
/sbin/iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT

### ==========================================
### CAMADA 1: TR√ÅFEGO CONFI√ÅVEL
### ==========================================

### üü¢ Loopback
/sbin/iptables -A INPUT -i lo -j ACCEPT
/sbin/iptables -A OUTPUT -o lo -j ACCEPT

### üîê VPN WireGuard (tr√°fego confi√°vel)
/sbin/iptables -A INPUT -i wg0 -j ACCEPT
/sbin/iptables -A OUTPUT -o wg0 -j ACCEPT
/sbin/iptables -A FORWARD -i wg0 -j ACCEPT
/sbin/iptables -A FORWARD -o wg0 -j ACCEPT

### üîÑ Conex√µes estabelecidas (maior volume)
/sbin/iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
/sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
/sbin/iptables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

### ==========================================
### CAMADA 2: BLOQUEIOS CR√çTICOS
### ==========================================

### üö´ BLOCKLIST
/sbin/iptables -A INPUT -j BLOCKLIST
/sbin/iptables -A FORWARD -j BLOCKLIST

### ‚ùå Pacotes Inv√°lidos
/sbin/iptables -A INPUT -m conntrack --ctstate INVALID -j DROP
/sbin/iptables -A FORWARD -m conntrack --ctstate INVALID -j DROP

### üö´ Anti-spoofing
/sbin/iptables -A INPUT -s 127.0.0.0/8 ! -i lo -j DROP
/sbin/iptables -A INPUT -s 224.0.0.0/4 -j DROP
/sbin/iptables -A INPUT -s 240.0.0.0/5 -j DROP
/sbin/iptables -A INPUT -s 169.254.0.0/16 -j DROP
/sbin/iptables -A INPUT -s 0.0.0.0/8 -j DROP
/sbin/iptables -A INPUT -s 255.255.255.255 -j DROP

### üö´ FLAGS TCP Maliciosas
/sbin/iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags FIN,ACK FIN -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags ACK,PSH PSH -j DROP
/sbin/iptables -A INPUT -p tcp --tcp-flags ACK,URG URG -j DROP

### ==========================================
### CAMADA 3: PROTE√á√ÉO GLOBAL (SEM SSH)
### ==========================================

### üõ°Ô∏è Configurar GLOBAL_PROTECT
# IPs banidos temporariamente (30 min)
/sbin/iptables -A GLOBAL_PROTECT -m recent --name GLOBAL_BAN --rcheck --seconds 1800 -j DROP

# Flood agressivo (10 conex√µes em 10s - mais tolerante)
/sbin/iptables -A GLOBAL_PROTECT -m recent --name GLOBAL_FLOOD --update --seconds 10 --hitcount 10 -j DROP
/sbin/iptables -A GLOBAL_PROTECT -m recent --name GLOBAL_FLOOD --set

# Limite de conex√µes simult√¢neas (50 por IP - mais permissivo)
/sbin/iptables -A GLOBAL_PROTECT -m connlimit --connlimit-above 50 --connlimit-mask 32 -j REJECT --reject-with tcp-reset

# Rate limit para novas conex√µes (5/s, burst 10 - mais generoso)
/sbin/iptables -A GLOBAL_PROTECT -m conntrack --ctstate NEW -m limit --limit 5/s --limit-burst 10 -j RETURN
/sbin/iptables -A GLOBAL_PROTECT -m conntrack --ctstate NEW -j DROP

### üîê Configurar PORTSCAN
/sbin/iptables -A PORTSCAN -p tcp --tcp-flags SYN,ACK,FIN,RST RST -m limit --limit 1/s --limit-burst 2 -j RETURN
/sbin/iptables -A PORTSCAN -j DROP

### ==========================================
### CAMADA 4: SERVI√áOS ESSENCIAIS
### ==========================================

### üì° ICMP (Ping) - Rate limit
/sbin/iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s --limit-burst 3 -j ACCEPT
/sbin/iptables -A INPUT -p icmp --icmp-type echo-request -j DROP
/sbin/iptables -A INPUT -p icmp -j ACCEPT

### üåê DNS (essencial)
/sbin/iptables -A INPUT -p udp --sport 53 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --sport 53 -j ACCEPT
/sbin/iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
/sbin/iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT

### ==========================================
### CAMADA 5: SERVI√áOS P√öBLICOS COM PROTE√á√ÉO
### ==========================================

### üéÆ Prote√ß√£o EXTRA para Lineage2 (3 conex√µes - mais permissivo)
/sbin/iptables -A INPUT -p tcp --dport 2106 -m connlimit --connlimit-above 3 --connlimit-mask 32 -j REJECT --reject-with tcp-reset
/sbin/iptables -A INPUT -p tcp --dport 7777 -m connlimit --connlimit-above 3 --connlimit-mask 32 -j REJECT --reject-with tcp-reset

### üåê Aplicar GLOBAL_PROTECT (EXCETO SSH!)
# Apenas portas que N√ÉO sejam SSH (22)
/sbin/iptables -A INPUT -i eth0 -p tcp ! --dport 22 -m conntrack --ctstate NEW -j GLOBAL_PROTECT

### üîê Prote√ß√£o contra Port Scan (EXCETO SSH)
/sbin/iptables -A INPUT -p tcp ! --dport 22 --tcp-flags SYN,ACK,FIN,RST RST -j PORTSCAN

### üåê Permitir portas do servidor
/sbin/iptables -A INPUT -p tcp -m multiport --dports 3306,7777,2106,9014,2000,445 -j ACCEPT
/sbin/iptables -A INPUT -p udp -m multiport --dports 3306,7777,2106,9014,445 -j ACCEPT

### ==========================================
### CAMADA 6: FORWARD E NAT (VPN)
### ==========================================

### üîÑ NAT - Redirecionamentos
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3306 -j DNAT --to-destination 10.66.66.2:3306
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 7777 -j DNAT --to-destination 10.66.66.2:7777
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 2106 -j DNAT --to-destination 10.66.66.2:2106
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 9014 -j DNAT --to-destination 10.66.66.2:9014
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 2000 -j DNAT --to-destination 10.66.66.2:2000
/sbin/iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 445 -j DNAT --to-destination 10.66.66.2:445

### üéÆ Prote√ß√£o Lineage2 no FORWARD
/sbin/iptables -A FORWARD -p tcp --dport 2106 -m connlimit --connlimit-above 3 --connlimit-mask 32 -j REJECT --reject-with tcp-reset
/sbin/iptables -A FORWARD -p tcp --dport 7777 -m connlimit --connlimit-above 3 --connlimit-mask 32 -j REJECT --reject-with tcp-reset

### üåê Aplicar GLOBAL_PROTECT no FORWARD
/sbin/iptables -A FORWARD -i eth0 -p tcp -m conntrack --ctstate NEW -j GLOBAL_PROTECT

### üîÄ Forward VPN
/sbin/iptables -A FORWARD -i wg0 -o eth0 -s 10.66.66.0/24 -j ACCEPT
/sbin/iptables -A FORWARD -i eth0 -o wg0 -d 10.66.66.2 -p tcp -m multiport --dports 2000,445,9014,3306,2106,7777 -j ACCEPT
/sbin/iptables -A FORWARD -i wg0 -o eth0 -s 10.66.66.2 -p tcp -m multiport --sports 2000,445,9014,3306,2106,7777 -j ACCEPT

### ==========================================
### CAMADA 7: LOGGING E BLOQUEIO FINAL
### ==========================================

### üìä Configurar LOGDROP
/sbin/iptables -A LOGDROP -m limit --limit 5/min -j LOG --log-prefix "FW-BLOCK: " --log-level 4
/sbin/iptables -A LOGDROP -j DROP

### üåç OUTPUT geral
/sbin/iptables -A OUTPUT -j ACCEPT

### üö´ Bloquear resto
/sbin/iptables -A INPUT -j LOGDROP
/sbin/iptables -A FORWARD -j LOGDROP


exit 0
